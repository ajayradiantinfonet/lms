{% extends 'boot_header.html'%}
        <!-- End of Topbar -->

        <!-- Begin Page Content -->
{% block course_details %}
{% load static %}
{% load mytag %}
{% load crispy_forms_tags %}


  <title>Drag Drop Activity</title>

  <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" rel="stylesheet" type="text/css" crossorigin="anonymous" />
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css" rel="stylesheet" type="text/css" crossorigin="anonymous" />
  <script src="https://code.jquery.com/jquery-3.5.1.min.js" integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0=" crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js" crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/3.4.0/fabric.min.js"></script>
  <script src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"> 
  </script> 

  <style type="text/css">
    .resizeableEl{
      resize: both;
      overflow: auto; 
    }
    .makeDraggableForCreate{
      cursor: move;
    }
    .makeDraggable{
      cursor: move;
    }
    .resizable {
      width: 100px;
      height: 100px;
      position: absolute;
      top: 100px;
      left: 100px;
      border:1px dashed #4286f4;
    }

    .resizable .resizers{
      width: 100%;
      height: 100%;
      border: 3px dashed #4286f4;
      box-sizing: border-box;
    }

    .resizable .resizers .resizer{
      width: 10px;
      height: 10px;
      border-radius: 50%;
      background: white;
      border: 2px solid #4286f4;
      position: absolute;
    }
    .resizable .resizers .resizer.top-left {
      left: -5px;
      top: -5px;
      cursor: nwse-resize; /*resizer cursor*/
    }
    .resizable .resizers .resizer.top-right {
      right: -5px;
      top: -5px;
      cursor: nesw-resize;
    }
    .resizable .resizers .resizer.bottom-left {
      left: -5px;
      bottom: -5px;
      cursor: nesw-resize;
    }
    .resizable .resizers .resizer.bottom-right {
      right: -5px;
      bottom: -5px;
      cursor: nwse-resize;
    }

    .dropzoneLabel{
      display:block;
      position: absolute;
      top: 0;
      text-align: center;
      width: 100%;
    }

    .text-resizable {
      height: 40px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }

    
    .textLabel{
      display:block;
      position: absolute;
      text-align: center;
      width: 100%;
    }

    .contentEditor{
      position: absolute;
      top: -28px;
      width: 100%;
      text-align: center;
    }

  </style>
</head>
<body>

  <div class="col-sm-12 row mx-0 mt-2">
    <div class="container">
      <ul class="nav nav-tabs" id="drag_drop_nav_tab">
        <li class="nav-item" id="basicSettingsNav" onclick="tabActive('#basicSettingsNav', '#baseSettingsTab')">
          <a class="nav-link active" href="#">Base Settings</a>
        </li>
        <li class="nav-item" id="addItemNav" onclick="tabActive('#addItemNav', '#addItemsTab')">
          <a class="nav-link disabled" href="#">Add Activity Elements</a>
        </li>
        <!-- <li class="nav-item">
          <a class="nav-link disabled" href="#">Disabled</a>
        </li> -->
      </ul>
    </div>
  </div>
  <div class="col-sm-12 row mx-0 my-4">

    <div class="container">
      <div class="col-sm-3 row mx-0" style="float: left;">
        <div class="row mx-0" id="baseSettingsTab">
          <div class="form-group">
            <label for="titleInput">
              Title
              <sup><span style="color:#ff0000;">*</span></sup>
            </label>
            <input type="text" name="title" id="titleInput" class="form-control" onkeyup="onTitleChange(this)" onchange="onTitleChange(this)">
            <small id="titleHelp" class="form-text text-muted">Title for the activity</small>
          </div>
          <div class="form-group">
            <label>
              Background :
            </label>
            <small id="backgroundHelp" class="form-text text-muted">Optional. Select an image to use as background for your drag and drop task.</small>
            <button class="btn btn-outline-dark" id="addBackground" style="font-weight: 800;" onclick="document.getElementById('backgroundImage').click()">
              Add Background <span style="" class="fa fa-plus"></span>
            </button>
            <input type="file" id="backgroundImage" style="display:none" accept="image/jpg,image/png,image/jpeg" onchange="uploadBackground(event, this)" />
          </div>
          <div class="form-group">
            <div id="prevBackGround" style="display: none; width:160px; height:80px;">
              
            </div>
          </div>
          <div class="form-group">
            <label style="display: block;">
              Play Area Dimensions:
            </label>
            <input type="text" name="width" id="width" value="800" style="padding: 5px; border: 1px solid #ddd; border-radius: 5px; width:80px;" onkeyup="onWidthChange(this)" onchange="onWidthChange(this)">
              <span style="font-weight: 800; font-size: 24px; margin: 0px 10px;">X</span>
            <input type="text" name="height" id="height" value="400" style="padding: 5px; border: 1px solid #ddd; border-radius: 5px; width:80px;" onkeyup="onHeightChange(this)" onchange="onHeightChange(this)">
            <small id="dimensionHelp" class="form-text text-muted">Specify how large (in px) the play area should be.</small>
          </div>
          <div class="form-group">
            <button class="btn btn-success" onclick="saveBasicSettings()">
              Save Settings
            </button>
          </div>
          
        </div>
        <div class="row mx-0" id="addItemsTab" style="display: none;">
          <div class="form-group">
            <label>
              Add items to play area :
            </label>
            <small id="playItemsHelp" class="form-text text-muted">Add droppable zone and items in.</small>
            <button class="btn btn-primary" data-toggle="modal" data-target="#dropzoneSettingsModal"><!-- onclick="addDropzoneToPlayArea()"> -->
              <span style="" class="fa fa-plus"></span> Dropzone
            </button>
            <br>
            <br>
            <button class="btn btn-primary" data-toggle="modal" data-target="#textSettingsModal">
              <span style="" class="fa fa-plus"></span> Text
            </button>
            <br>
            <br>
            <button class="btn btn-primary" data-toggle="modal" data-target="#imageSettingsModal">
              <span style="" class="fa fa-plus"></span> Image
            </button>
            <br>
            <br>
            
          </div>
        </div>
      </div>
      <div class="col-sm-9 row mx-0" style="float: left;">
        <div class="row mx-0" style="width:100%;">
          <div style="padding: 5px; margin: 0px;"><h2 style="margin: 0px; text-align: center;" id="activity_title"></h2></div>
        </div>
        <div class="row mx-0" style="width:100%;">
          <div class="wrapper" id="activityPlayer" >
      
          </div>
        </div>
      </div>
      
    </div>
    
  </div>

<div class="modal fade" id="dropzoneSettingsModal" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="dropzoneSettingsModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="dropzoneSettingsModalLabel">Dropzone Settings</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Label<sup style="color:red;">*</sup></label>
            <input type="text" id="dropZlabel" class="form-control">
          </div>

          <div class="form-group">
            <input type="checkbox" id="dropZlabelShow" >
            <label>Show Label</label>
          </div>
          <div class="form-group">
            <div>
              <label>Select Correct Elements :</label>
            </div>
            <div id="correctElementSelectorBox">
              <input type="checkbox" value="all" id="dropZCorrectAll" onchange="checkAllSiblings(this)">
              <label>Select all</label>
            </div>            
          </div>
          <div class="form-group">
            <label>Background Opacity :</label>
            <input type="text" class="form-control" id="dropZBackground" value="0" style="width:100px; padding: 5px; border-radius: 5px;">
            <small class="form-text text-muted">Value will be 0 to 100, where 0 for invisible/no background and 100 for full visible background</small>
          </div>

          <div class="form-group">
            <input type="checkbox" id="checkForOneElementDrop" >
            <label class="form-text">This drop zone can only contain one element</label>
            <small class="form-text text-muted">if you check this,then make sure there is only one correct answer for this dropzone</small>
          </div>
          
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger-outline" data-dismiss="modal">Remove</button>
          <button type="button" class="btn btn-primary" id="addDropZBtn" onclick="onDropZoneSave(this, false)">Add</button>
          <button type="button" class="btn btn-primary" id="editDropZBtn" style="display:none;" onclick="onDropZoneSave(this, true)">Save Changes</button>
        </div>
      </div>
    </div>
</div>

<div class="modal fade" id="textSettingsModal" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="textSettingsModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="textSettingsModalLabel">Text Settings</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <label>Text<sup style="color:red;">*</sup></label>
            <input type="text" id="textlabel" class="form-control">
          </div>

          <!-- <div class="form-group">
            <input type="checkbox" id="textlabelShow" >
            <label >Show Label</label>
          </div> -->
          <div class="form-group">
            <div>
              <label>Select Dropzones :</label>
            </div>
            <div id="correctElementSelectorBox">
              <input type="checkbox" value="all" id="textCorrect" onchange="checkAllSiblings(this)">
              <label>Select all</label>
            </div>            
          </div>
          <div class="form-group">
            <label>Background Opacity :</label>
            <input type="text" class="form-control" id="textBackground" value="100" style="width:100px; padding: 5px; border-radius: 5px;">
            <small class="form-text text-muted">Value will be 0 to 100, where 0 for invisible/no background and 100 for full visible background</small>
          </div>

          <!-- <div class="form-group">
            <input type="checkbox" id="checkForOneElementDrop" class="form-control" >
            <label class="form-text">This drop zone can only contain one element</label>
            <small class="form-text text-muted">if you check this,then make sure there is only one correct answer for this dropzone</small>
          </div> -->
          
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger-outline" data-dismiss="modal">Remove</button>
          <button type="button" class="btn btn-primary" id="addTextElBtn" onclick="onTextSave(this, false)">Add</button>
          <button type="button" class="btn btn-primary" id="editTextElBtn" style="display:none;" onclick="onTextSave(this, true)">Save Changes</button>
        </div>
      </div>
    </div>
</div>

<div class="modal fade" id="imageSettingsModal" data-backdrop="static" tabindex="-1" role="dialog" aria-labelledby="imageSettingsModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="imageSettingsModalLabel">Image Settings</h5>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <div class="form-group">
            <button class="btn btn-outline-dark" id="addImageElement" style="font-weight: 800;" onclick="document.getElementById('imageElementSelector').click()">
              Add Image <span style="" class="fa fa-plus"></span>
            </button>
            <button class="btn btn-outline-dark" id="editImageElement" style="display:none;font-weight: 800;" onclick="document.getElementById('imageElementSelector').click()">
              Edit Image <span style="" class="fa fa-cog"></span>
            </button>
            <input type="file" id="imageElementSelector" style="display:none" accept="image/jpg,image/png,image/jpeg" onchange="uploadImageElement(event, this)" />
            <br>
            <div style="width:120px;height: 120px;" id="imageElementPreview">
              
            </div>
          </div>

          <div class="form-group">
            <label>Alternative Text<sup style="color:red;">*</sup></label>
            <input type="text" id="imageText" class="form-control">
          </div>

          <div class="form-group">
            <label>Hover Text<sup style="color:red;">*</sup></label>
            <input type="text" id="imageHoverText" class="form-control">
          </div>

          <!-- <div class="form-group">
            <input type="checkbox" id="textlabelShow" >
            <label >Show Label</label>
          </div> -->
          <div class="form-group">
            <div>
              <label>Select Dropzones :</label>
            </div>
            <div id="correctElementSelectorBoxImage">
              <input type="checkbox" value="all" id="imageCorrect" onchange="checkAllSiblings(this)">
              <label>Select all</label>
            </div>            
          </div>
          <div class="form-group">
            <label>Background Opacity :</label>
            <input type="text" class="form-control" id="imageBackground" value="0" style="width:100px; padding: 5px; border-radius: 5px;">
            <small class="form-text text-muted">Value will be 0 to 100, where 0 for invisible/no background and 100 for full visible background</small>
          </div>

          <!-- <div class="form-group">
            <input type="checkbox" id="checkForOneElementDrop" class="form-control" >
            <label class="form-text">This drop zone can only contain one element</label>
            <small class="form-text text-muted">if you check this,then make sure there is only one correct answer for this dropzone</small>
          </div> -->
          
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-danger-outline" data-dismiss="modal">Remove</button>
          <button type="button" class="btn btn-primary" id="addImageElBtn" onclick="onImageSave(this, false)">Add</button>
          <button type="button" class="btn btn-primary" id="editImageElBtn" style="display:none;" onclick="onImageSave(this, true)">Save Changes</button>
        </div>
      </div>
    </div>
</div>

  <script>

    var activityPlayerConf = {
      title : "Test title",
      width:"800",
      height:"400",
      background: {
        image:false,
        src:'https://kaveri.s3.ap-south-1.amazonaws.com/images/originals/161102115111385.png',
        isColor:false,
        color:'#f9f9f9',
      },
      elements:{
        draggable:[
          {
            type : "text",
            label:"First label",
            elid:"option1",
            labelShow:true,
            text:"First option Text",
            color:"red",
            border:true,
            correct:true,
            height:'50px',
            width:'150px',
            positionX:'10',
            positionY:'20',
            border:true,
            borderColor:'#666',
          },
          {
            type : "text",
            labelShow:true,
            elid:"option2",
            label:"Second label",
            text:"Second option Text",
            color:"blue",
            correct:true,
            height:'50px',
            width:'150px',
            positionX:'400',
            positionY:'20',
          },
          {
            type : "image",
            label:"Third label",
            elid:"option3",
            labelShow:true,
            src:"https://kaveri.s3.ap-south-1.amazonaws.com/images/originals/161102115111385.png",
            correct:false,
            height:'50px',
            width:'150px',
            positionX:'10',
            positionY:'150',
          },
          {
            type : "rect",
            label:"forth label",
            elid:"option4",
            text:"Second option Text",
            color:"white",
            correct:true,
            background:"blue",
            rectProps: {
              stroke: 'red', 
              strokeWidth: 1,
              fill: ''
            },
            height:'50px',
            width:'150px',
            positionX: '400',
            positionY:'150',
          }
        ],
        droppable:[
          {
            label:"First droppable",
            text:"First droppable Text",
            color:"red",
            elid:"drop1",
            backgroundImage:true,
            backgroundColor:false,
            backgroundSrc:'https://kaveri.s3.ap-south-1.amazonaws.com/images/originals/161102115111385.png',
            correct:true,
            border:true,
            borderColor:'#666',
            height:'100px',
            width:'500px',
            positionX:'100',
            positionY:'250',
          },
        ],
      }
    };

    var GlobalDataForDragDropActivity = {};

    $(document).ready(function(e){


      $('#bac').click(function(){ $('#backgroundImageUpload').trigger('click'); });
      basePlayArea();

      /*
      var html = '';
      var innerContent = '';

      if(activityPlayerConf != undefined){
        document.querySelector('#activity_title').textContent = activityPlayerConf.title;
        var baseStyle = 'border:1px #000 solid; width:'+activityPlayerConf.width+'px; height:'+activityPlayerConf.height+'px;';
        if(activityPlayerConf.background.image == true){
          baseStyle += "background-image:url('"+activityPlayerConf.background.src+"'); background-size:contain; background-repeat:no-repeat; background-position:center;";
        }
        if(activityPlayerConf.background.isColor == true){
          baseStyle += "background-color:"+activityPlayerConf.background.color+";";
        }
        

        html += '<div style="'+baseStyle+'" id="baseContainerElement">'+innerContent+'</div>';

        document.querySelector('#activityPlayer').innerHTML = html;
        var basePosition = $("#baseContainerElement").position();

        var elementsDraggable = activityPlayerConf.elements.draggable;
        var draggableHtml = '';
        for(var i in elementsDraggable){
           draggableHtml += createDraggableElement(elementsDraggable[i], basePosition);
        }

        var elementsDroppable = activityPlayerConf.elements.droppable;
        var droppableHtml = '';
        for(var i in elementsDroppable){
           droppableHtml += createDroppableElement(elementsDroppable[i], basePosition);
        }

        document.querySelector("#baseContainerElement").innerHTML = draggableHtml + droppableHtml;

        bindDraggable();
        bindDroppable();

      }
      */

    });

    function enableTooltip(){
      $('.textLabel[data-toggle="tooltip"]').tooltip();
    }
    function onTitleChange(t){
      document.querySelector('#activity_title').textContent = t.value;
    }

    function onWidthChange(t){
      var val = parseInt(t.value);
      if(val === parseInt(val,10)){
        $('#baseContainerElement').css('width', val+'px');
      }else{
        alert('Please insert numbers only');
      }
    }

    function onHeightChange(t){
      var val = parseInt(t.value);
      if(val === parseInt(val,10)){
        $('#baseContainerElement').css('height', val+'px');
      }else{
        alert('Please insert numbers only');
      }
    }

    function basePlayArea(){
        var width=$('#width').val();
        var height = $('#height').val();
        var playArea = '<div style="border:1px #000 solid; width:'+width+ 'px; height:'+height+'px;" id="baseContainerElement"></div>';

        document.querySelector('#activityPlayer').innerHTML = playArea;
    }

    function createDraggableElement(elementConf, basePosition){
      let item = '';
      var hw = 'width:'+elementConf.width+';height:'+elementConf.height+';';
          var draggableStyle = 'position:absolute; top:'+(basePosition.top+parseInt(elementConf.positionY))+'px; left:'+(basePosition.top+parseInt(elementConf.positionX))+'px; color:'+elementConf.color+';'+hw;
          if(elementConf.border != undefined && elementConf.border == true){
            draggableStyle += 'border:1px '+elementConf.borderColor+' solid;';
          }

          item += '<div style="'+draggableStyle+'" class="makeDraggable" data-draggable="'+elementConf.elid+'">';

          if(elementConf.labelShow == true){
            item += '<label>'+elementConf.label+'</label>';
          }

          if(elementConf.type == "text"){
            item += '<div stye="'+hw+'">'+elementConf.text+'</div>';
          }

          if(elementConf.type == "image"){
            item += '<img stye="'+hw+'" src="'+elementConf.src+'"/>';
          }

          if(elementConf.type == "rect"){
            item += '<div style="background-color:'+elementConf.background+'; color:'+elementConf.color+'; '+hw+'" ><p>'+elementConf.text+'</p></div>';
          }

          item += '</div>';

          return item;
    }


    function createDroppableElement(elementConf, basePosition){
      let item = '';
      var hw = 'width:'+elementConf.width+';height:'+elementConf.height+';';
          var draggableStyle = 'position:absolute; top:'+(basePosition.top+parseInt(elementConf.positionY))+'px; left:'+(basePosition.top+parseInt(elementConf.positionX))+'px; color:'+elementConf.color+';'+hw;
          if(elementConf.border != undefined && elementConf.border == true){
            draggableStyle += 'border:1px '+elementConf.borderColor+' solid;';
          }

          if(elementConf.backgroundImage == true){
            draggableStyle += "background-image:url('"+elementConf.backgroundSrc+"'); background-size:contain; background-position:center; background-repeat:no-repeat;";
          }

          item += '<div style="'+draggableStyle+'" class="makeDroppable" data-droppable="'+elementConf.elid+'">';

          if(elementConf.labelShow == true){
            item += '<label>'+elementConf.label+'</label>';
          }

          if(elementConf.text == true){
            item += '<p>'+elementConf.text+'</p>';
          }

          item += '</div>';

          return item;
    }


    function bindDraggable(){
      $(".makeDraggable").draggable({ revert: 'invalid' });
    }

    function bindDraggableForCreate(){
      $(".makeDraggableForCreate").draggable({'containment':'#baseContainerElement'});//.resizable();
    }

    function bindDroppable(){
      var dropablesData = [];
      $(".makeDroppable").droppable({
        drop: function(event, ui) {
          var opid = $(ui.draggable).attr('data-draggable');
          var dropid = $(this).attr('data-droppable');
          if(dropablesData[dropid] != undefined){
            if(Array.isArray(dropablesData[dropid])){
              dropablesData[dropid].push(opid);
            }else{
              dropablesData[dropid] = new Array();
              dropablesData[dropid].push(opid);
            }
          }else{
            dropablesData[dropid] = new Array();
            dropablesData[dropid].push(opid);
          }
          console.log(dropablesData);
          //return $(ui.draggable).addClass('drag-revert');
          
          alert('You just droped an element inside this droppable zone');
        }
      });
    }

    function tabActive(tabId, tabItem)
    {
        $(tabId).siblings('.nav-item').children('.nav-link').removeClass('active');
        $(tabId).children('.nav-link').addClass('active');
        $(tabItem).siblings('div').css('display', "none");
        $(tabItem).css('display', "block");
      //}
    }

    function uploadBackground(event,t)
    {

      var ext = $(t).val().split('.').pop().toLowerCase();
      if($.inArray(ext, ['png','jpg','jpeg']) == -1) {
        alert('invalid file type only jpeg, jpg, png file are allowed');
      }else{
        var reader = new FileReader();
        reader.onload = function(){
          $("#baseContainerElement").attr('data-back-src', ''+reader.result);
          $("#baseContainerElement").css({
            'background-color': '',
            'background-size':'contain', 
            'background-repeat':'no-repeat',
            'background-position':'center',
            'background-image': 'url("'+reader.result+'")'
          });
        };
        reader.readAsDataURL(event.target.files[0]);
      }

    }

    function uploadImageElement(event,t)
    {
      var ext = $(t).val().split('.').pop().toLowerCase();
      if($.inArray(ext, ['png','jpg','jpeg']) == -1) {
        alert('invalid file type only jpeg, jpg, png file are allowed');
      }
      else
      {
        var reader = new FileReader();
        reader.onload = function(){
          $("#imageElementPreview").attr('data-img-src', ''+reader.result);
          $("#imageElementPreview").html('<img style="margin-top:20px; width:100%; height:auto;" src="'+reader.result+'">');
          $("#addImageElement").css('display', "none");
          $("#editImageElement").css('display', "inline-block");
        };
        reader.readAsDataURL(event.target.files[0]);
      }
    }

    var drag_activity_id='';
    function saveBasicSettings()
    {
      var title = $("#titleInput").val();
      var width = $("#width").val() +'px';
      var height = $("#height").val() + 'px';
      var isIm = false;
      var isclr = false;
      var srcIm = false;
      var reader = new FileReader();
      if($("#backgroundImage").prop('files')[0]){
        isIm = true;
        srcIm = $("#baseContainerElement").attr('data-back-src');
      }
      else
      {
        srcIm = "";
      }

      var background = {
        image : isIm,
        src : srcIm,
        isColor: isclr,
        color: "#ffffff"
      };

      GlobalDataForDragDropActivity.title = title;
      GlobalDataForDragDropActivity.width = width;
      GlobalDataForDragDropActivity.height = height;
      GlobalDataForDragDropActivity.background = background;
      GlobalDataForDragDropActivity.topicid = "{{topicid}}";
      //console.log(GlobalDataForDragDropActivity);

      $.ajax({
        url: '{% url "customadmin:add_drag" %}'+"{{ topicid }}/",
        type:'post',
        headers:'Content-Type=application/json',
        data : GlobalDataForDragDropActivity,
        success: function(res){
          alert(res);
          drag_activity_id=res;
          tabActive('#addItemNav', '#addItemsTab');
        }
      });
      tabActive("#addItemNav", "#addItemsTab");
    }

    function onDropZoneSave(t, editStatus){
        
      console.log('on dz edit save');
      var dropZlabel = $("#dropZlabel").val();
      var dropZlabelShow = 0;
      if($("#dropZlabelShow").is(":checked")){
        dropZlabelShow = 1;
      }

      var dropZBackgroundOpacity = $("#dropZBackground").val();

      var dropZCorrect = '';

      $("#dropZCorrectAll").siblings('input').each(function(e){
        if($(this).is(":checked")){
          var val = $(this).attr('data-elid');
          dropZCorrect += val+',';
        }
      });

      var checkForOneElementDrop = 0;

      if ($("#checkForOneElementDrop").is(":checked")) {
        checkForOneElementDrop = 1;
      }

      var p = $(t).position();


      var dropZData = {
        label:dropZlabel,
        labelShow:dropZlabelShow,
        backgroundOpacity:dropZBackgroundOpacity,
        correctDroppables:dropZCorrect,
        dropOnlyOne:checkForOneElementDrop,
        left: p.left,
        top: p.top,

      };

      //alert(dropZData);

      $.ajax({
        url:'{% url "customadmin:add_drag_element" %}'+drag_activity_id+"/", 
        type:'post',
        data:dropZData,
        success:function(res){
          console.log(res);
          var i = res.id;
          addDropzoneToPlayArea(i, dropZData);
          $("#dropzoneSettingsModal").modal('hide');
        }
      });

      var i = $('.resizable').length;
      if(editStatus == true){
        i = $(t).attr('data-sid');
        var elid = $(t).attr('data-elid');
        var height = $(elid).outerHeight();
        var width = $(elid).outerWidth();
        var position = $(elid).position();
        $(elid).remove();
        addDropzoneToPlayArea(i, dropZData);
        $(elid).css({
          "height": height+"px",
          "width" : width+"px",
          "top" : position.top + "px",
          "left" : position.left + "px"
        });

        $("#dropZlabel").val("");
        $("#dropZlabelShow").removeAttr("checked");
        $("#dropZlabelShow").prop("checked", "false");
        $("#dropZCorrectAll").removeAttr("checked");
        $("#dropZCorrectAll").prop("checked", "false");
        $("#checkForOneElementDrop").removeAttr("checked");
        $("#checkForOneElementDrop").prop("checked", "false");
        $("#dropZBackground").val("0");
        $("#addDropZBtn").css('display', '');
        $("#editDropZBtn").css('display', 'none');

      }else{
        addDropzoneToPlayArea(i, dropZData);
      }
      $("#dropzoneSettingsModal").modal('hide');
    }

    function addDropzoneToPlayArea(i, data){
      var op = 0;
      if(parseInt(data.backgroundOpacity)){
        var x = parseInt(data.backgroundOpacity);
        if(x > 0 && x <= 100){
          op = x/100;
        }
      }
      //add a resizable div in aplay area to setup a dropzone
      var iconsHtml="<div style='padding:1px; text-align:center;' ><span class='fa fa-hand-o-right'></span></div>";
      // var i = $('.resizable').length;
      // var el_count = $('.resizable').length;
      // i = i + el_count;
      // var baseDivHtml = "<div class='makeDraggableForCreate' style=''>"+ //iconsHtml+
      var baseDivHtml = "<div id='dropzone"+ i+"' data-id='"+i+"' data-content='"+JSON.stringify(data)+"' style='background-color:rgba(153, 194, 255, "+op+");' class='resizable makeDraggableForCreate' data-drag='false' data-resize='true' onclick='selectElementForModify(this)'>"+
      "<div class='contentEditor' style='display:none;' ><label style='background-color:rgba(153, 194, 255, 0.4); border-radius:5px;' onclick='editDropZoneSettings(this, "+'"#dropzone'+ i+'"'+")'><span class='fa fa-pen'></span> Edit</label></div>"+ 
      "<div class='resizers'>"+ 
      "<div class='resizer top-left'></div>"+
      "<div class='resizer top-right'></div>"+
      "<div class='resizer bottom-left'></div>"+
      "<div class='resizer bottom-right'></div>"+
      "</div>"+
      "<div class='dropzoneLabel' style='display:"+(data.labelShow == 0 ? 'none' : 'block')+";'><label>"+data.label+"</label></div>"+
      "</div>";
      //var b = "<div class='makeDraggableForCreate' style='width:100px;height:100px; border: 2px dashed blue;background-color:#99c2ff;'></div>"

      $("#baseContainerElement").append(baseDivHtml);
      bindDraggableForCreate();
      makeResizableDiv('#dropzone'+i + '');
      $('#dropzone'+i + '').trigger('click');
      enableTooltip();
    }

    function checkAllSiblings(t){
      if($(t).is(":checked")){
        $(t).siblings('input').prop('checked','checked');
      }
    }

    function makeResizableDiv(div) {
      const element = document.querySelector(div);
      const resizers = document.querySelectorAll(div + ' .resizer')
      const minimum_size = 20;
      let original_width = 0;
      let original_height = 0;
      let original_x = 0;
      let original_y = 0;
      let original_mouse_x = 0;
      let original_mouse_y = 0;
      for (let i = 0;i < resizers.length; i++) {
        const currentResizer = resizers[i];
        currentResizer.addEventListener('mousedown', function(e) {
          //if(!$(this).attr('data-drag')){
            e.preventDefault()
            original_width = parseFloat(getComputedStyle(element, null).getPropertyValue('width').replace('px', ''));
            original_height = parseFloat(getComputedStyle(element, null).getPropertyValue('height').replace('px', ''));
            original_x = element.getBoundingClientRect().left;
            original_y = element.getBoundingClientRect().top;
            original_mouse_x = e.pageX;
            original_mouse_y = e.pageY;
            window.addEventListener('mousemove', resize)
            window.addEventListener('mouseup', stopResize)
          //}
        });
        
        function resize(e) {
          if (currentResizer.classList.contains('bottom-right')) {
            const width = original_width + (e.pageX - original_mouse_x);
            const height = original_height + (e.pageY - original_mouse_y)
            if (width > minimum_size) {
              element.style.width = width + 'px'
            }
            if (height > minimum_size) {
              element.style.height = height + 'px'
            }
          }
          else if (currentResizer.classList.contains('bottom-left')) {
            const height = original_height + (e.pageY - original_mouse_y)
            const width = original_width - (e.pageX - original_mouse_x)
            if (height > minimum_size) {
              element.style.height = height + 'px'
            }
            if (width > minimum_size) {
              element.style.width = width + 'px'
              element.style.left = original_x + (e.pageX - original_mouse_x) + 'px'
            }
          }
          else if (currentResizer.classList.contains('top-right')) {
            const width = original_width + (e.pageX - original_mouse_x)
            const height = original_height - (e.pageY - original_mouse_y)
            if (width > minimum_size) {
              element.style.width = width + 'px'
            }
            if (height > minimum_size) {
              element.style.height = height + 'px'
              element.style.top = original_y + (e.pageY - original_mouse_y) + 'px'
            }
          }
          else {
            const width = original_width - (e.pageX - original_mouse_x)
            const height = original_height - (e.pageY - original_mouse_y)
            if (width > minimum_size) {
              element.style.width = width + 'px'
              element.style.left = original_x + (e.pageX - original_mouse_x) + 'px'
            }
            if (height > minimum_size) {
              element.style.height = height + 'px'
              element.style.top = original_y + (e.pageY - original_mouse_y) + 'px'
            }
          }
        }
        
        function stopResize() {
          window.removeEventListener('mousemove', resize)
        }
      }
    }

    function selectElementForModify(t){
      $("#baseContainerElement").children('.resizable').attr('data-drag', 'true');
      $("#baseContainerElement").children('.resizable').attr('data-resize', 'false');
      $("#baseContainerElement").children('.resizable').children('.resizers').css('display', 'none');
      $("#baseContainerElement").children('.resizable').children('.contentEditor').css('display', 'none');
      $(t).attr('data-resize', 'true');
      $(t).attr('data-drag', 'false');
      $(t).children('.contentEditor').css('display', '');
      $(t).children('.resizers').css('display', '');
    }
    
    function onTextSave(t, editStatus){
      console.log('on txt save');
      var textLabel = $("#textlabel").val();
      var textLabelShow = 1;

      var textBackgroundOpacity = $("#textBackground").val();

      var textDropZones = '';

      $("#textCorrect").siblings('input').each(function(e){
        if($(this).is(":checked")){
          var val = $(this).attr('data-elid');
          textDropZones += val+',';
        }
      });

      // var checkForOneElementDrop = 0;

      // if ($("#checkForOneElementDrop").is(":checked")) {
      //   checkForOneElementDrop = 1;
      // }

      var textData = {
        label:textLabel,
        text:textLabel,
        labelShow:textLabelShow,
        backgroundOpacity:textBackgroundOpacity,
        canDroppables:textDropZones,
        // dropOnlyOne:checkForOneElementDrop,
      };

      /*$.post('/activity/create/drag-drop-element', textData,function(res){
          var i = res.id;
          addTextToPlayArea(i, textData);
          $("#textSettingsModal").modal('hide');
      });*/

      var i = $('.resizable').length;
      if(editStatus == true){
        i = $(t).attr('data-sid');
        var elid = $(t).attr('data-elid');
        var height = $(elid).outerHeight();
        var width = $(elid).outerWidth();
        var position = $(elid).position();
        $(elid).remove();
        addTextToPlayArea(i, textData);
        $(elid).css({
          "height": height+"px",
          "width" : width+"px",
          "top" : position.top + "px",
          "left" : position.left + "px"
        });

        $("#textlabel").val("");
        $("#textCorrect").removeAttr("checked");
        $("#textBackground").val("100");
        $("#addTextElBtn").css('display', '');
        $("#editTextElBtn").css('display', 'none');
      }else{
        addTextToPlayArea(i, textData);
      }
      $("#textSettingsModal").modal('hide');
    }

    
    function addTextToPlayArea(i, data){
      var op = 0;
      if(parseInt(data.backgroundOpacity)){
        var x = parseInt(data.backgroundOpacity);
        if(x > 0 && x <= 100){
          op = x/100;
        }
      }
      //add a resizable div in aplay area to setup a dropzone
      var iconsHtml="<div style='padding:1px; text-align:center;' ><span class='fa fa-hand-o-right'></span></div>";
      // var i = $('.resizable').length;
      // var el_count = $('.resizable').length;
      // i = i + el_count;
      // var baseDivHtml = "<div class='makeDraggableForCreate' style=''>"+ //iconsHtml+
      var baseDivHtml = "<div id='text"+ i+"' data-id='"+i+"' data-content='"+JSON.stringify(data)+"'  style='background-color:rgba(204, 204, 204, "+op+"); border-radius:5px;flex-direction: column;display: flex;justify-content: center;' class='resizable makeDraggableForCreate text-resizable' data-drag='false' data-resize='true' onclick='selectElementForModify(this)'>"+
      "<div class='contentEditor' style='display:none;' ><label style='background-color:rgba(153, 194, 255, 0.4); border-radius:5px;' onclick='editTextSettings(this, "+'"#text'+ i+'"'+")'><span class='fa fa-pen'></span> Edit</label></div>"+ 
      "<div class='resizers'>"+ 
      "<div class='resizer top-left'></div>"+
      "<div class='resizer top-right'></div>"+
      "<div class='resizer bottom-left'></div>"+
      "<div class='resizer bottom-right'></div>"+
      "</div>"+
      "<div class='textLabel' style=''><p style='margin:0px; font-weight:600;'>"+data.text+"</p></div>"+
      "</div>";
      //var b = "<div class='makeDraggableForCreate' style='width:100px;height:100px; border: 2px dashed blue;background-color:#99c2ff;'></div>"

      $("#baseContainerElement").append(baseDivHtml);
      bindDraggableForCreate();
      makeResizableDiv('#text'+i + '');
      $('#text'+i + '').trigger('click');
      enableTooltip();
    }


    function onImageSave(t, editStatus){
      console.log('on img save');
      var imglabel = $("#imageText").val();
      var imghover = $("#imageHoverText").val();
      var imglabelShow = 1;

      var imgBackgroundOpacity = $("#imageBackground").val();

      var imgCorrect = '';

      $("#imageCorrect").siblings('input').each(function(e){
        if($(this).is(":checked")){
          var val = $(this).attr('data-elid');
          imgCorrect += val+',';
        }
      });
      var imgSrc = $("#imageElementPreview").attr('data-img-src');
      // var checkForOneElementDrop = 0;

      // if ($("#checkForOneElementDrop").is(":checked")) {
      //   checkForOneElementDrop = 1;
      // }

      var imageData = {
        label:imglabel,
        labelShow:imglabelShow,
        imageHoverText:imghover,
        backgroundOpacity:imgBackgroundOpacity,
        correctDroppables:imgCorrect,
        src:imgSrc,
        //dropOnlyOne:checkForOneElementDrop,
      };

      /*$.post('/activity/create/drag-drop-element', dropZData,function(res){
          var i = res.id;
          addDropzoneToPlayArea(i, imageData);
          $("#dropzoneSettingsModal").modal('hide');
      });*/

      var i = $('.resizable').length;
      if(editStatus == true){
        i = $(t).attr('data-sid');
        var elid = $(t).attr('data-elid');
        var height = $(elid).outerHeight();
        var width = $(elid).outerWidth();
        var position = $(elid).position();
        $(elid).remove();
        addImageToPlayArea(i, imageData);
        $(elid).css({
          "height": height+"px",
          "width" : width+"px",
          "top" : position.top + "px",
          "left" : position.left + "px"
        });

        $("#imageText").val("");
        $("#imageHoverText").val("");
        $("#imageCorrect").removeAttr("checked");
        $("#imageBackground").val("0");
        $("#imageElementPreview").html('');
        $("#addImageElBtn").css('display', '');
        $("#editImageElBtn").css('display', 'none');

      }else{
        addImageToPlayArea(i, imageData);
      }
      $("#imageSettingsModal").modal('hide');
    }

    
    function addImageToPlayArea(i, data){
      var op = 0;
      if(parseInt(data.backgroundOpacity)){
        var x = parseInt(data.backgroundOpacity);
        if(x > 0 && x <= 100){
          op = x/100;
        }
      }
      //add a resizable div in aplay area to setup a dropzone
      var iconsHtml="<div style='padding:1px; text-align:center;' ><span class='fa fa-hand-o-right'></span></div>";
      // var i = $('.resizable').length;
      // var el_count = $('.resizable').length;
      // i = i + el_count;
      // var baseDivHtml = "<div class='makeDraggableForCreate' style=''>"+ //iconsHtml+
      var baseDivHtml = "<div id='image"+ i+"' data-id='"+i+"' data-content='"+JSON.stringify(data)+"' style='background-color:rgba(153, 194, 255, "+op+");flex-direction: column;display: flex;justify-content: center;' class='resizable makeDraggableForCreate' data-drag='false' data-resize='true' onclick='selectElementForModify(this)'>"+
      "<div class='contentEditor' style='display:none;'><label style='background-color:rgba(153, 194, 255, 0.4); border-radius:5px;padding:2px 5px;' onclick='editImageSettings(this, "+'"#image'+ i+'"'+")'><span class='fa fa-pen'></span> Edit</label></div>"+ 
      "<div class='resizers'>"+ 
      "<div class='resizer top-left'></div>"+
      "<div class='resizer top-right'></div>"+
      "<div class='resizer bottom-left'></div>"+
      "<div class='resizer bottom-right'></div>"+
      "</div>"+
      "<div class='textLabel' style='padding:1px;height:100% ' data-toggle='tooltip' title='"+data.imageHoverText+"'><img style='width:95%; height:95%;' src='"+data.src+"' alt='"+ data.label+"'></div>"+
      "</div>";
      //var b = "<div class='makeDraggableForCreate' style='width:100px;height:100px; border: 2px dashed blue;background-color:#99c2ff;'></div>"

      $("#baseContainerElement").append(baseDivHtml);
      bindDraggableForCreate();
      makeResizableDiv('#image'+i + '');
      $('#image'+i + '').trigger('click');
      //enableTooltip();
    }


    function editDropZoneSettings(t, elid){
      var d = $(elid).attr('data-content');
      console.log(d);
      d = JSON.parse(d);
      var sid = $(elid).attr('data-id');

      
      $("#dropzoneSettingsModal").modal('show');
      $("#addDropZBtn").css('display', 'none');
      $("#editDropZBtn").css('display', '');
      $("#editDropZBtn").attr('data-sid', ''+sid);
      $("#editDropZBtn").attr('data-elid', ''+elid);

      $("#dropZlabel").val(d.label);
      if(d.labelShow == 1){
        $("#dropZlabelShow").prop("checked", "true");
      }

      $("#dropZBackground").val(d.backgroundOpacity);
      if(d.dropOnlyOne == 1){
        $("#checkForOneElementDrop").prop("checked", "true");
      }


    }

    function editTextSettings(t, elid){
      var d = $(elid).attr('data-content');
      console.log(d);
      d = JSON.parse(d);
      var sid = $(elid).attr('data-id');

      
      $("#textSettingsModal").modal('show');
      $("#addTextElBtn").css('display', 'none');
      $("#editTextElBtn").css('display', '');
      $("#editTextElBtn").attr('data-sid', ''+sid);
      $("#editTextElBtn").attr('data-elid', ''+elid);
      
      $("#textlabel").val(d.label);  
      if(d.labelShow == 1){
        $("#textlabelShow").prop("checked", "true");
      }

      $("#textBackground").val(d.backgroundOpacity);
      if(d.dropOnlyOne == 1){
        $("#checkForOneElementDrop").prop("checked", "true");
      }
    }

    function editImageSettings(t, elid){
      var d = $(elid).attr('data-content');
      console.log(d);
      d = JSON.parse(d);
      var sid = $(elid).attr('data-id');

      
      $("#imageSettingsModal").modal('show');
      $("#addImageElBtn").css('display', 'none');
      $("#editImageElBtn").css('display', '');
      $("#editImageElBtn").attr('data-sid', ''+sid);
      $("#editImageElBtn").attr('data-elid', ''+elid);
      
      $("#imagelabel").val(d.label);  
      $("#imageHoverText").val(d.imageHoverText);  
      if(d.labelShow == 1){
        $("#imagelabelShow").prop("checked", "true");
      }

      $("#imageBackground").val(d.backgroundOpacity);
      $("#imageElementPreview").attr('data-img-src', ''+d.src);
      $("#imageElementPreview").html('<img style="margin-top:20px; width:100%; height:auto;" src="'+d.src+'">');
      $("#addImageElement").css('display', "none");
      $("#editImageElement").css('display', "inline-block");
    }
    
  </script>

</body>

</html>

{% endblock %}